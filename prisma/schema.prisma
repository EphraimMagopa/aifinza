// Aifinza - Financial Management Platform for South African SMBs
// Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==================== AUTHENTICATION ====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  image         String?
  password      String?
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  businesses    BusinessUser[]
  aiSettings    UserAISettings?
  subscription  Subscription?
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

// ==================== SUBSCRIPTIONS ====================

model Subscription {
  id                     String             @id @default(cuid())
  userId                 String             @unique
  stripeCustomerId       String?            @unique
  stripeSubscriptionId   String?            @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?
  plan                   SubscriptionPlan   @default(FREE)
  status                 SubscriptionStatus @default(ACTIVE)
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum SubscriptionPlan {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
  TRIALING
}

// ==================== BUSINESS ====================

model Business {
  id                 String       @id @default(cuid())
  name               String
  tradingName        String?
  registrationNumber String? // CIPC registration
  taxNumber          String? // SARS tax number
  vatNumber          String? // VAT registration number
  isVatRegistered    Boolean      @default(false)
  vatCycle           VatCycle?
  businessType       BusinessType
  industry           String?
  financialYearEnd   Int          @default(2) // Month (1-12), Feb = 2

  // Contact Details
  email   String?
  phone   String?
  website String?

  // Address
  addressLine1 String?
  addressLine2 String?
  city         String?
  province     Province?
  postalCode   String?
  country      String    @default("South Africa")

  // Settings
  defaultCurrency   String @default("ZAR")
  logoUrl           String?
  invoicePrefix     String @default("INV")
  quotePrefix       String @default("QUO")
  nextInvoiceNumber Int    @default(1)
  nextQuoteNumber   Int    @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users                 BusinessUser[]
  bankAccounts          BankAccount[]
  customers             Customer[]
  suppliers             Supplier[]
  transactions          Transaction[]
  invoices              Invoice[]
  quotes                Quote[]
  employees             Employee[]
  chartOfAccounts       ChartOfAccount[]
  taxPeriods            TaxPeriod[]
  documents             Document[]
  categories            Category[]
  recurringTransactions RecurringTransaction[]
}

model BusinessUser {
  id         String       @id @default(cuid())
  userId     String
  businessId String
  role       BusinessRole @default(MEMBER)
  createdAt  DateTime     @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([userId, businessId])
}

enum BusinessRole {
  OWNER
  ADMIN
  ACCOUNTANT
  MEMBER
  VIEWER
}

enum BusinessType {
  SOLE_PROPRIETOR
  PARTNERSHIP
  PRIVATE_COMPANY // (Pty) Ltd
  PUBLIC_COMPANY
  CLOSE_CORPORATION // CC
  NON_PROFIT
  TRUST
  OTHER
}

enum Province {
  EASTERN_CAPE
  FREE_STATE
  GAUTENG
  KWAZULU_NATAL
  LIMPOPO
  MPUMALANGA
  NORTHERN_CAPE
  NORTH_WEST
  WESTERN_CAPE
}

enum VatCycle {
  MONTHLY // Category A: > R30m turnover
  BI_MONTHLY // Category B: R1.5m - R30m
  SIX_MONTHLY // Category C: < R1.5m (voluntary)
}

// ==================== BANKING ====================

model BankAccount {
  id             String          @id @default(cuid())
  businessId     String
  name           String
  bankName       String
  accountNumber  String
  branchCode     String?
  accountType    BankAccountType
  currency       String          @default("ZAR")
  currentBalance Decimal         @default(0) @db.Decimal(15, 2)
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  business     Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  transactions Transaction[]
}

enum BankAccountType {
  CURRENT
  SAVINGS
  CREDIT_CARD
  LOAN
  CASH
  OTHER
}

// ==================== CHART OF ACCOUNTS ====================

model ChartOfAccount {
  id          String          @id @default(cuid())
  businessId  String
  code        String // e.g., "1000", "4100"
  name        String
  description String?
  type        AccountCategory
  subType     String?
  isSystem    Boolean         @default(false)
  isActive    Boolean         @default(true)
  parentId    String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  business     Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)
  parent       ChartOfAccount?  @relation("AccountHierarchy", fields: [parentId], references: [id])
  children     ChartOfAccount[] @relation("AccountHierarchy")
  transactions Transaction[]

  @@unique([businessId, code])
}

enum AccountCategory {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  COST_OF_SALES
  EXPENSE
  OTHER_INCOME
  OTHER_EXPENSE
}

// ==================== TRANSACTIONS ====================

model Transaction {
  id            String          @id @default(cuid())
  businessId    String
  bankAccountId String?
  accountId     String? // Chart of account
  categoryId    String?
  customerId    String?
  supplierId    String?
  invoiceId     String?

  date        DateTime
  description String
  reference   String?
  amount      Decimal         @db.Decimal(15, 2)
  type        TransactionType

  // VAT
  vatRate   Decimal? @db.Decimal(5, 2)
  vatAmount Decimal? @db.Decimal(15, 2)
  vatType   VatType?

  // Reconciliation
  isReconciled Boolean   @default(false)
  reconciledAt DateTime?

  // AI categorization
  aiCategorized Boolean @default(false)
  aiConfidence  Float?

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business    Business              @relation(fields: [businessId], references: [id], onDelete: Cascade)
  bankAccount BankAccount?          @relation(fields: [bankAccountId], references: [id])
  account     ChartOfAccount?       @relation(fields: [accountId], references: [id])
  category    Category?             @relation(fields: [categoryId], references: [id])
  customer    Customer?             @relation(fields: [customerId], references: [id])
  supplier    Supplier?             @relation(fields: [supplierId], references: [id])
  invoice     Invoice?              @relation(fields: [invoiceId], references: [id])
  documents   TransactionDocument[]
}

model RecurringTransaction {
  id          String          @id @default(cuid())
  businessId  String
  description String
  amount      Decimal         @db.Decimal(15, 2)
  type        TransactionType
  frequency   Frequency
  startDate   DateTime
  endDate     DateTime?
  nextDueDate DateTime
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
  JOURNAL
}

enum VatType {
  STANDARD // 15%
  ZERO_RATED // 0%
  EXEMPT // No VAT
  NO_VAT // Not VAT registered
}

enum Frequency {
  DAILY
  WEEKLY
  FORTNIGHTLY
  MONTHLY
  QUARTERLY
  ANNUALLY
}

// ==================== CATEGORIES ====================

model Category {
  id         String          @id @default(cuid())
  businessId String
  name       String
  type       TransactionType
  color      String?
  icon       String?
  isSystem   Boolean         @default(false)
  parentId   String?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  business     Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  parent       Category?     @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children     Category[]    @relation("CategoryHierarchy")
  transactions Transaction[]

  @@unique([businessId, name])
}

// ==================== CUSTOMERS & SUPPLIERS ====================

model Customer {
  id         String    @id @default(cuid())
  businessId String
  name       String
  email      String?
  phone      String?
  vatNumber  String?

  // Billing Address
  addressLine1 String?
  addressLine2 String?
  city         String?
  province     Province?
  postalCode   String?
  country      String    @default("South Africa")

  // Settings
  paymentTerms Int      @default(30) // Days
  creditLimit  Decimal? @db.Decimal(15, 2)
  notes        String?
  isActive     Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business     Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  invoices     Invoice[]
  quotes       Quote[]
  transactions Transaction[]
}

model Supplier {
  id         String    @id @default(cuid())
  businessId String
  name       String
  email      String?
  phone      String?
  vatNumber  String?

  // Address
  addressLine1 String?
  addressLine2 String?
  city         String?
  province     Province?
  postalCode   String?
  country      String    @default("South Africa")

  // Banking
  bankName      String?
  accountNumber String?
  branchCode    String?

  // Settings
  paymentTerms Int     @default(30)
  notes        String?
  isActive     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business     Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  transactions Transaction[]
}

// ==================== INVOICING ====================

model Invoice {
  id         String @id @default(cuid())
  businessId String
  customerId String
  quoteId    String?

  invoiceNumber String
  reference     String?
  status        InvoiceStatus @default(DRAFT)

  issueDate DateTime  @default(now())
  dueDate   DateTime
  paidDate  DateTime?

  // Amounts
  subtotal   Decimal @db.Decimal(15, 2)
  vatAmount  Decimal @db.Decimal(15, 2)
  discount   Decimal @default(0) @db.Decimal(15, 2)
  total      Decimal @db.Decimal(15, 2)
  amountPaid Decimal @default(0) @db.Decimal(15, 2)

  // Content
  notes String?
  terms String?

  // Email tracking
  sentAt   DateTime?
  viewedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business     Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  customer     Customer          @relation(fields: [customerId], references: [id])
  quote        Quote?            @relation(fields: [quoteId], references: [id])
  lineItems    InvoiceLineItem[]
  transactions Transaction[]
  documents    Document[]

  @@unique([businessId, invoiceNumber])
}

model InvoiceLineItem {
  id          String  @id @default(cuid())
  invoiceId   String
  description String
  quantity    Decimal @db.Decimal(10, 2)
  unitPrice   Decimal @db.Decimal(15, 2)
  vatRate     Decimal @default(15) @db.Decimal(5, 2)
  vatAmount   Decimal @db.Decimal(15, 2)
  lineTotal   Decimal @db.Decimal(15, 2)
  sortOrder   Int     @default(0)

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PARTIALLY_PAID
  PAID
  OVERDUE
  CANCELLED
  WRITTEN_OFF
}

// ==================== QUOTES ====================

model Quote {
  id         String @id @default(cuid())
  businessId String
  customerId String

  quoteNumber String
  reference   String?
  status      QuoteStatus @default(DRAFT)

  issueDate  DateTime @default(now())
  expiryDate DateTime

  // Amounts
  subtotal  Decimal @db.Decimal(15, 2)
  vatAmount Decimal @db.Decimal(15, 2)
  discount  Decimal @default(0) @db.Decimal(15, 2)
  total     Decimal @db.Decimal(15, 2)

  notes String?
  terms String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business  Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)
  customer  Customer        @relation(fields: [customerId], references: [id])
  lineItems QuoteLineItem[]
  invoices  Invoice[]

  @@unique([businessId, quoteNumber])
}

model QuoteLineItem {
  id          String  @id @default(cuid())
  quoteId     String
  description String
  quantity    Decimal @db.Decimal(10, 2)
  unitPrice   Decimal @db.Decimal(15, 2)
  vatRate     Decimal @default(15) @db.Decimal(5, 2)
  vatAmount   Decimal @db.Decimal(15, 2)
  lineTotal   Decimal @db.Decimal(15, 2)
  sortOrder   Int     @default(0)

  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  DECLINED
  EXPIRED
  INVOICED
}

// ==================== PAYROLL ====================

model Employee {
  id         String @id @default(cuid())
  businessId String

  // Personal
  firstName String
  lastName  String
  idNumber  String?
  email     String?
  phone     String?

  // Employment
  employeeNumber String?
  jobTitle       String?
  department     String?
  startDate      DateTime
  endDate        DateTime?
  employmentType EmploymentType

  // Compensation
  salaryType   SalaryType
  salaryAmount Decimal    @db.Decimal(15, 2)
  payFrequency Frequency  @default(MONTHLY)

  // Tax
  taxNumber String? // SARS tax number

  // Banking
  bankName      String?
  accountNumber String?
  branchCode    String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  payslips Payslip[]
}

model Payslip {
  id         String @id @default(cuid())
  employeeId String

  payPeriodStart DateTime
  payPeriodEnd   DateTime
  payDate        DateTime

  // Earnings
  basicSalary Decimal @db.Decimal(15, 2)
  overtime    Decimal @default(0) @db.Decimal(15, 2)
  bonus       Decimal @default(0) @db.Decimal(15, 2)
  commission  Decimal @default(0) @db.Decimal(15, 2)
  allowances  Decimal @default(0) @db.Decimal(15, 2)
  grossPay    Decimal @db.Decimal(15, 2)

  // Deductions
  paye            Decimal @db.Decimal(15, 2) // Income tax
  uif             Decimal @db.Decimal(15, 2) // Unemployment Insurance
  pensionEmployee Decimal @default(0) @db.Decimal(15, 2)
  medicalAid      Decimal @default(0) @db.Decimal(15, 2)
  otherDeductions Decimal @default(0) @db.Decimal(15, 2)
  totalDeductions Decimal @db.Decimal(15, 2)

  // Employer contributions
  uifEmployer     Decimal @db.Decimal(15, 2)
  sdl             Decimal @db.Decimal(15, 2) // Skills Development Levy
  pensionEmployer Decimal @default(0) @db.Decimal(15, 2)

  netPay Decimal       @db.Decimal(15, 2)
  status PayslipStatus @default(DRAFT)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  TEMPORARY
  INTERN
}

enum SalaryType {
  MONTHLY
  HOURLY
  ANNUAL
}

enum PayslipStatus {
  DRAFT
  APPROVED
  PAID
}

// ==================== TAX ====================

model TaxPeriod {
  id         String    @id @default(cuid())
  businessId String
  type       TaxType
  startDate  DateTime
  endDate    DateTime
  dueDate    DateTime
  status     TaxStatus @default(OPEN)

  // Amounts (for VAT)
  outputVat  Decimal? @db.Decimal(15, 2)
  inputVat   Decimal? @db.Decimal(15, 2)
  vatPayable Decimal? @db.Decimal(15, 2)

  // Submission
  submittedAt DateTime?
  reference   String? // SARS reference

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

enum TaxType {
  VAT // VAT201
  PAYE // EMP201
  PROVISIONAL_TAX // IRP6
  ANNUAL_TAX // IT12/ITR14
  EMP501 // Annual PAYE reconciliation
  SDL // Skills Development Levy
  UIF // Unemployment Insurance Fund
}

enum TaxStatus {
  OPEN
  IN_PROGRESS
  READY_TO_SUBMIT
  SUBMITTED
  PAID
  OVERDUE
}

// ==================== DOCUMENTS ====================

model Document {
  id         String @id @default(cuid())
  businessId String
  invoiceId  String?

  name     String
  type     DocumentType
  fileUrl  String
  fileSize Int
  mimeType String

  // AI processing
  aiProcessed   Boolean @default(false)
  extractedData Json?

  taxYear  Int?
  category String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business     Business              @relation(fields: [businessId], references: [id], onDelete: Cascade)
  invoice      Invoice?              @relation(fields: [invoiceId], references: [id])
  transactions TransactionDocument[]
}

model TransactionDocument {
  id            String @id @default(cuid())
  transactionId String
  documentId    String

  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  document    Document    @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([transactionId, documentId])
}

enum DocumentType {
  INVOICE
  RECEIPT
  BANK_STATEMENT
  CONTRACT
  TAX_CERTIFICATE
  ID_DOCUMENT
  COMPANY_REGISTRATION
  VAT_REGISTRATION
  OTHER
}

// ==================== AI ====================

model UserAISettings {
  id              String     @id @default(cuid())
  userId          String     @unique
  defaultProvider AIProvider @default(CLAUDE)

  // API Keys (encrypted)
  openaiKey    String?
  anthropicKey String?
  geminiKey    String?
  deepseekKey  String?

  // Preferences
  enableAutoCateg Boolean @default(true)
  enableInsights  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AIConversation {
  id         String     @id @default(cuid())
  userId     String
  businessId String?
  title      String?
  provider   AIProvider
  model      String
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  messages AIMessage[]
}

model AIMessage {
  id             String      @id @default(cuid())
  conversationId String
  role           MessageRole
  content        String      @db.Text
  tokenCount     Int?
  createdAt      DateTime    @default(now())

  conversation AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

enum AIProvider {
  OPENAI
  CLAUDE
  GEMINI
  DEEPSEEK
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

// ==================== CALENDAR & SCHEDULING ====================

model CalendarEvent {
  id         String    @id @default(cuid())
  businessId String
  userId     String

  title       String
  description String?
  type        EventType

  startDate DateTime
  endDate   DateTime?
  allDay    Boolean   @default(false)

  // Recurrence
  isRecurring    Boolean @default(false)
  recurrenceRule String? // iCal RRULE format

  // Reminders
  reminderMinutes Int[] @default([1440, 60]) // 1 day, 1 hour

  // Related entities
  relatedId   String? // Invoice ID, Tax Period ID, etc.
  relatedType String?

  completed   Boolean   @default(false)
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum EventType {
  TAX_DEADLINE
  INVOICE_DUE
  PAYMENT_DUE
  MEETING
  REMINDER
  PAYROLL
  CUSTOM
}

// ==================== AUDIT LOG ====================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  businessId String?
  action     String
  entityType String
  entityId   String
  oldValues  Json?
  newValues  Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
}
